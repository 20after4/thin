#!/usr/bin/env ruby
# Script used to launch multiple server instances.
# It takes most of the same argument as the +thin+ script
# plus the -n option to specify the number of servers to run.
# 
# Also you can store your options into a config file, create it like this:
#  thin_cluster -c /var/www/my_app/current config
# Then a config file will be created in /var/www/my_app/current/config/thin.yml
# with the default options.
# You can launch your 3 servers with:
#  thin_cluster start
# And stop them with:
#  thin_cluster stop
#
# Run <tt>thin_cluster -h</tt> do get help.

require File.dirname(__FILE__) + '/../lib/thin'

Thin::Commander.new(ARGV) do |command|
  command.include_options :port, :address, :environment, :servers, :log_file, :pid_file, :config
  
  command.before do
    Dir.chdir command.options.cwd if command.options.cwd
    command.options.log_file ||= 'log/thin.log'
  end
  
  command.on :start do
    command.load_from_config
    
    command.options.servers.times do |n|
      port = command.options.port + n
      
      puts "Starting server on #{command.options.address}:#{port}"
      
      server = Thin::Server.new(command.options.address, port,
                                # Let Rails handle his thing and ignore files
                                Thin::RailsHandler.new('.', command.options.environment),
                                # Serve static files
                                Thin::DirHandler.new('public')
                               )
      
      # Include port number in log and pid file names
      FileUtils.mkdir_p File.dirname(command.options.log_file)
      server.logger   = Logger.new(command.include_port_number(command.options.log_file, port))
      server.pid_file = command.include_port_number(command.options.pid_file, port)
      
      server.daemonize
    end
  end

  command.on :stop do
    command.load_from_config
    
    command.error "PID file required to stop server" unless command.options.pid_file
    command.error "Port number required to stop server" unless command.options.port
    
    command.options.servers.times do |n|
      port = command.options.port + n
      Thin::Server.kill(command.include_port_number(command.options.pid_file, port))
    end
  end
  
  command.on :config do
    command.dump_config
  end
end
