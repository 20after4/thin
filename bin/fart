#!/usr/bin/env ruby

require File.dirname(__FILE__) + '/../lib/fart'
require 'optparse'
require 'ostruct'

def start!(options)
  server = Fart::Server.new(options.host, options.port,
                            Fart::RailsHandler.new(options.path, options.env), # Let Rails handle his thing and ignore files
                            Fart::DirHandler.new(File.join(options.path, 'public')) # Serve static files
                           )
  server.run
end

options = OpenStruct.new
options.host = '0.0.0.0'
options.port = 3000
options.path = Dir.pwd
options.env = 'development'

opts = OptionParser.new do |opts|
  opts.banner = "Usage: fart [options]"

  opts.separator ""
  opts.separator "Specific options:"

  opts.on("-w", "--wkdir PATH", "Working directory (default: current)") do |path|
    options.path = path
  end

  opts.on("-p", "--port PORT", "Port number to bind to (default: 3000)") do |port|
    options.port = port.to_i
  end
  
  opts.on("-a", "--address ADDR", "Address to bind to") do |host|
    options.host = host
  end
  
  opts.on("-e", "--env ENV", "Rails environment (default: development)") do |env|
    options.env = env
  end

  opts.separator ""
  opts.separator "Common options:"

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end

  opts.on_tail("--version", "Show version") do
    puts Fart::SERVER
    exit
  end
end

opts.parse!(ARGV)

start! options